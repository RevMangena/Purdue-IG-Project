pipeline {
    agent { label 'jenkins-slave' }

    environment {
        DOCKER_IMAGE_NAME = 'revmangena/my-tomcat-app'
    }

    stages {
        stage('1. Compile') {
            steps {
                sh 'mvn compile'
            }
        }

        stage('2. Test') {
            steps {
                sh 'mvn test'
            }
        }

        stage('3. Package') {
            steps {
                sh 'mvn package'
            }
        }

        stage('Create Dockerfile') {
            steps {
                script {
                    // Prepare the Docker build context
                    sh '''
                        cd /home/ubuntu
                        rm -rf warfile
                        mkdir warfile
                        cp /tmp/jenkinsdir/workspace/Docker-PipelineFile/target/ABCtechnologies-1.0.war warfile/
                        cd warfile
                        cat <<EOT > Dockerfile
                        FROM tomcat:9.0.73-jdk8-corretto-al2
                        ADD . /usr/local/tomcat/webapps
                        EOT
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh '''
                        cd /home/ubuntu/warfile
                        docker build -t my-tomcat-app .
                        docker tag my-tomcat-app ${DOCKER_IMAGE_NAME}
                    '''
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    sh 'docker push ${DOCKER_IMAGE_NAME}'
                }
            }
        }
    }
}
